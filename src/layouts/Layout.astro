---
export interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Chris wird 50 — 19. September 2026, Hamburg" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <title>{title}</title>
  </head>
  <body class="overflow-x-hidden bg-[#f4f1ec] text-[#1a1d2e] font-['Inter',sans-serif]">
    <slot />
    <script>
      // ---- Countdown ----
      function updateCountdown() {
        const partyDate = new Date('2026-09-19T13:00:00Z').getTime();
        const now = new Date().getTime();
        const diff = partyDate - now;

        if (diff <= 0) {
          const el = document.getElementById('countdown');
          if (el) el.innerHTML = '<span class="font-mono text-2xl text-white/60">Jetzt.</span>';
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        const setVal = (id: string, val: number) => {
          const el = document.getElementById(id);
          if (el) el.textContent = String(val).padStart(2, '0');
        };

        setVal('cd-days', days);
        setVal('cd-hours', hours);
        setVal('cd-minutes', minutes);
        setVal('cd-seconds', seconds);
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);

      // ---- Fixed Map with numbered pins ----
      const mapEl = document.getElementById('map');

      if (mapEl) {
        import('leaflet').then((L) => {
          const isMobile = window.innerWidth < 768;

          // Stations for numbered pins
          const stations = [
            { num: 1, name: 'Strandperle', lat: 53.5445, lng: 9.9055 },
            { num: 2, name: 'Anleger Övelgönne', lat: 53.5441122, lng: 9.9120346 },
            { num: 3, name: 'Barkassenfahrt', lat: 53.5435, lng: 9.9370 },
            { num: 4, name: 'Landungsbrücken', lat: 53.5451, lng: 9.9631 },
            { num: 5, name: 'La Cocina', lat: 53.5494, lng: 9.9739 },
          ];

          // Routes
          const strandperleWalkRoute: [number, number][] = [
            [53.5445, 9.9055], [53.5444, 9.9070], [53.5443, 9.9085],
            [53.5442, 9.9100], [53.5441122, 9.9120346],
          ];

          const barkasseRoute: [number, number][] = [
            [53.5441122, 9.9120346], [53.5435, 9.9160], [53.5428, 9.9220],
            [53.5424, 9.9280], [53.5422, 9.9330], [53.5421, 9.9370],
            [53.5422, 9.9410], [53.5424, 9.9445], [53.5427, 9.9480],
            [53.5431, 9.9510], [53.5435, 9.9540], [53.5440, 9.9570],
            [53.5445, 9.9600], [53.5449, 9.9620], [53.5451, 9.9631],
          ];

          const walkRoute: [number, number][] = [
            [53.5451, 9.9631], [53.5453, 9.9650], [53.5455, 9.9675],
            [53.5458, 9.9700], [53.5455, 9.9720], [53.5460, 9.9735],
            [53.5470, 9.9740], [53.5480, 9.9738], [53.5490, 9.9739],
            [53.5494, 9.9739],
          ];

          // Create map — fit all stations
          const map = L.map(mapEl, {
            zoomControl: false,
            attributionControl: false,
            scrollWheelZoom: false,
            dragging: !isMobile,
            tap: false,
            doubleClickZoom: false,
            touchZoom: false,
            keyboard: false,
          });

          // Fit bounds to show all stations
          const bounds = L.latLngBounds(stations.map(s => [s.lat, s.lng] as [number, number]));
          map.fitBounds(bounds, { padding: [40, 40] });

          setTimeout(() => map.invalidateSize(), 300);
          const resizeObserver = new ResizeObserver(() => {
            map.invalidateSize();
            map.fitBounds(bounds, { padding: [40, 40] });
          });
          resizeObserver.observe(mapEl);

          L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 19,
          }).addTo(map);

          L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 19,
            opacity: 0.6,
          }).addTo(map);

          // Draw routes
          L.polyline(strandperleWalkRoute, { color: '#6b7084', weight: 2, opacity: 0.4, dashArray: '6, 8' }).addTo(map);
          L.polyline(barkasseRoute, { color: '#c2703e', weight: 2.5, opacity: 0.5, dashArray: '8, 8' }).addTo(map);
          L.polyline(walkRoute, { color: '#6b7084', weight: 2, opacity: 0.4, dashArray: '6, 8' }).addTo(map);

          // Google-style numbered pins
          stations.forEach((station) => {
            const icon = L.divIcon({
              className: 'numbered-pin',
              html: `<div style="
                position: relative;
                width: 28px;
                height: 36px;
              ">
                <svg viewBox="0 0 28 36" width="28" height="36" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                  <path d="M14 0C6.27 0 0 6.27 0 14c0 10.5 14 22 14 22s14-11.5 14-22C28 6.27 21.73 0 14 0z" fill="#E53935"/>
                  <circle cx="14" cy="13" r="8" fill="#C62828"/>
                  <text x="14" y="17" text-anchor="middle" fill="white" font-family="'Space Grotesk',Arial,sans-serif" font-size="12" font-weight="600">${station.num}</text>
                </svg>
              </div>`,
              iconSize: [28, 36],
              iconAnchor: [14, 36],
            });

            const marker = L.marker([station.lat, station.lng], { icon }).addTo(map);
            marker.bindTooltip(station.name, {
              permanent: false,
              direction: 'top',
              className: 'map-tooltip',
              offset: [0, -36],
            });
          });

          // Highlight active station on card hover/intersection
          const stationCards = document.querySelectorAll<HTMLElement>('[data-station]');
          stationCards.forEach((card) => {
            card.addEventListener('mouseenter', () => {
              const idx = parseInt(card.dataset.station || '0') - 1;
              if (stations[idx]) {
                map.setView([stations[idx].lat, stations[idx].lng], isMobile ? 15 : 16, { animate: true, duration: 0.5 });
              }
            });
            card.addEventListener('mouseleave', () => {
              map.fitBounds(bounds, { padding: [40, 40] });
            });
          });
        });
      }
    </script>
  </body>
</html>
